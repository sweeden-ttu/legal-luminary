const fragments={video:[],audio:[]},audioVideoCopy=()=>{const e=[...fragments.video],o=[...fragments.audio];let s=e.length,t=o.length;if(s&&t){let n=e[s-1],i=o[t-1];for(;n.start>i.end&&n&&i;)e.splice(s-1,1),s=e.length,n=e[s-1];for(;i.start>n.end&&n&&i;)o.splice(t-1,1),t=e.length,i=o[t-1]}return{video:e,audio:o}};onmessage=async function(e){const{args:o,cmd:s}=e.data;if("PUSH"!==s)if("FLUSH"!==s)if("DATA_BACK"!==s){if("CLEAR"===s)return fragments.video.length=0,void(fragments.audio.length=0);if("SETTIMEOUT"===s){const{messageId:e,timeout:t}=o;setTimeout((()=>{postMessage({type:"response",response:{result:null,messageId:e,cmd:s}})}),t)}}else{const{messageId:e}=o;postMessage({type:"response",response:{result:fragments,messageId:e,cmd:s}})}else{const{videoInfo:e,audioInfo:t,isFmp4:n,clear:i,messageId:d,live:a}=o;let r=null;try{const{video:o,audio:s}=fragments;if(o.sort(((e,o)=>e.sn-o.sn)),s.sort(((e,o)=>e.sn-o.sn)),n){let n=[];n=a&&o.length&&s.length?audioVideoCopy():i?{video:[...o],audio:[...s]}:audioVideoCopy(),i&&(o.length=0,s.length=0);const d=n.video.reduce(((e,o)=>e+o.duration),0),u=n.audio.reduce(((e,o)=>e+o.duration),0),l=e.initSegment,g=t.initSegment,c=[...n.video,...n.audio],{FMP4Muxer:p}=await import("./fmp4-muxer.js"),m=p(i);m.on("progress",(e=>{postMessage({type:"progress",response:{data:e}})})),r=await m.convert(d,l,u,g,c)}else{const n={audioCodec:null,videoCodec:null};let d=null,u=e.initSegment||null,l=t.initSegment||null,g=[];g=a&&o.length&&s.length?audioVideoCopy():i?{video:[...o],audio:[...s]}:audioVideoCopy(),i&&(o.length=0,s.length=0);const c=g.video.reduce(((e,o)=>e+o.duration),0),p=g.audio.reduce(((e,o)=>e+o.duration),0);c&&(n.totalduration=c),n.audioCodec=e.audioCodec,n.videoCodec=e.videoCodec,p&&(d={totalduration:p,audioCodec:t.audioCodec});const m=[...g.video,...g.audio],{HLSMuxer:f}=await import("./hls-muxer.js"),v=f(i);v.on("progress",(e=>{postMessage({type:"progress",response:{data:e}})})),r=await v.convert(n,u,d,l,m)}}catch(e){console.error(e)}postMessage({type:"response",response:{result:r,messageId:d,cmd:s}})}else{const{frag:e}=o;("main"===e.type?fragments.video:fragments[e.type]).push(e)}},postMessage({});